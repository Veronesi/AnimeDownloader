<?php
include('regular.php');
$sv = 's1-en';
$value = $_POST['value'];
switch ($value) {
    # Iniciar Sesion.
    case 'IKA_SESION_NEW':
        # POST
        $IKA_SESION_NAME   = $_POST['IKA_SESION_NAME'];
        $IKA_SESION_PDW    = $_POST['IKA_SESION_PDW'];
        $IKA_SESION_SERVER = $_POST['IKA_SESION_SERVER'];
        $IKA_SESION_WORLD  = $_POST['IKA_SESION_WORLD'];
        ika_connect($IKA_SESION_NAME, $IKA_SESION_PDW, $IKA_SESION_WORLD, $IKA_SESION_SERVER);
        if(preg_match("/".$IKA_SESION_NAME."/", ika_save('view=city'))){
            print 'IKA_SESION_TRUE';
        }
        else{
            print 'IKA_SESION_FALSE';
        }
        break;
    case 'IKA_SESION_VALUE':
        $IKA_SESION_NAME   = $_POST['IKA_SESION_NAME'];
        $IKA_SESION_PDW    = $_POST['IKA_SESION_PDW'];
        $IKA_SESION_SERVER = $_POST['IKA_SESION_SERVER'];
        $IKA_SESION_WORLD  = $_POST['IKA_SESION_WORLD'];
        if(preg_match("/".$IKA_SESION_NAME."/", ika_save('view=city'))){
            print 'IKA_SESION_TRUE';
        }
        else{
            print 'IKA_SESION_FALSE';
        }
        break;
    case 'IKA_LIST_CITIES':
        $return="";
        $er = preg_match_all(regular::Ciudad(), ika_save('view=city'),$M);
        for($i = 0; $i < $er ; $i++ ){
            $return.= $M[1][$i].','.$M[2][$i].','.$M[3][$i].','.$M[4][$i].','.$M[5][$i]."|";
        }
        print $return;
        break;
    default:
        print $value;
        break;
}
function ika_connect($user, $pwd, $world, $country){
    $url = 'http://'.$world.'-'.$country.'.ikariam.gameforge.com/index.php?action=loginAvatar&function=login';
    $data = $world.'-'.$country.'.ikariam.gameforge.com&name='.$user.'&password='.$pwd.'&pwat_uid=&pwat_checksum=&startPageShown=1&detectedDevice=1&kid=&autoLogin=on';
    $headers= array(
        "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Content-Type: application/x-www-form-urlencoded",
        "Host: ".$world.'-'.$country.".ikariam.gameforge.com"
    );
    $fp = fopen("cookie.txt", "w");
    fclose($fp);
    $login = curl_init();
    curl_setopt($login, CURLOPT_COOKIEJAR, "cookie.txt");
    curl_setopt($login, CURLOPT_COOKIEFILE, "cookie.txt");
    curl_setopt($login, CURLOPT_TIMEOUT, 40000);
    curl_setopt($login, CURLOPT_RETURNTRANSFER, TRUE);
    curl_setopt($login, CURLOPT_REFERER, 'http://'.$world.'-'.$country.'.ikariam.gameforge.com/index.php?');
    curl_setopt($login, CURLOPT_URL, $url);
    curl_setopt($login, CURLOPT_HEADER, TRUE);
    curl_setopt($login, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($login, CURLOPT_ENCODING, 'gzip, deflate, br');
    curl_setopt($login, CURLOPT_USERAGENT, 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:54.0) Gecko/20100101 Firefox/54.0');
    curl_setopt($login, CURLOPT_FOLLOWLOCATION, TRUE);
    curl_setopt($login, CURLOPT_POST, TRUE);
    curl_setopt($login, CURLOPT_POSTFIELDS, $data);
    ob_start();
    return curl_exec ($login);
    ob_end_clean();
    curl_close ($login);
    unset($login);
}
function ika_save($site){
    global $sv;
    $headers= array(
        "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Content-Type: application/x-www-form-urlencoded",
        "Host: ".$sv.".ikariam.gameforge.com"
    );
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
    curl_setopt($ch, CURLOPT_HEADER, TRUE);
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_REFERER, 'http://'.$sv.'.ikariam.gameforge.com/index.php?');
    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:54.0) Gecko/20100101 Firefox/54.0');
    curl_setopt($ch, CURLOPT_ENCODING, 'gzip, deflate, br');
    curl_setopt($ch, CURLOPT_TIMEOUT, 40);
    curl_setopt($ch, CURLOPT_COOKIEFILE, "cookie.txt");
    curl_setopt($ch, CURLOPT_URL, 'http://'.$sv.'.ikariam.gameforge.com/index.php?'.$site);
    ob_start();
    return curl_exec ($ch);
    ob_end_clean();
    curl_close ($ch);
}